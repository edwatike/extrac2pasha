# Web Protection Bypass Tool

## Модули

### protections.py
Основной модуль для определения и обхода защит.

### protections/strategy_handler.py
Модуль для управления стратегиями обхода защит. Включает:
- SQLAlchemy модель `ProtectionStrategy` для хранения успешных стратегий
- Класс `StrategyHandler` для работы со стратегиями
- Методы поиска и применения стратегий
- Логирование всех действий
- Стандартные стратегии для известных типов защит

### protections/strategy_discovery.py
Модуль для исследования и открытия новых стратегий:
- Автоматический перебор экспериментальных подходов
- Сохранение успешных стратегий
- Логирование всех попыток
- Статистика успешности стратегий

### protections/solvers.py
Модуль с функциями-обходчиками для различных типов защит:
- `solve_with_playwright`: открывает страницу в headless-браузере
- `solve_with_headers_tweaking`: модифицирует заголовки запроса
- `solve_with_proxy`: делает запрос через внешний прокси
- `solve_with_retry_and_delay`: повторяет запрос через случайные интервалы

### agent/auto_extractor.py
Модуль авто-экстрактора для автоматического обхода защит:
- Автоматическое определение защиты
- Подбор и применение стратегий
- Сохранение результатов
- CLI интерфейс

### api/app.py
FastAPI приложение для предоставления REST API:
- Эндпоинты для извлечения содержимого
- Валидация входных данных
- Обработка ошибок
- CORS поддержка
- Документация API

### logger.py
Модуль для логирования событий.

## Тесты

### tests/test_protections.py
Тесты для основного модуля protections.py.

### tests/test_strategy_handler.py
Тесты для модуля управления стратегиями:
- Тест сохранения и поиска стратегий
- Тест применения стандартных стратегий

### tests/test_strategy_discovery.py
Тесты для модуля исследования стратегий:
- Тест успешного/неудачного открытия стратегии
- Тест перебора User-Agent'ов
- Тест использования Playwright
- Тест комбинаций прокси и заголовков
- Тест эмуляции геолокации
- Тест изменения разрешения экрана

### tests/test_solvers.py
Тесты для функций-обходчиков:
- Тест успешного/неудачного обхода через модификацию заголовков
- Тест успешного/неудачного обхода через повторные запросы

### tests/test_auto_extractor.py
Тесты для авто-экстрактора:
- Тест работы без защиты
- Тест работы с защитой
- Тест обработки ошибок
- Тест сохранения результатов

### tests/test_api.py
Тесты для API:
- Тест проверки работоспособности
- Тест успешного извлечения
- Тест обработки ошибок
- Тест валидации URL
- Тест работы с опциями
- Тест получения статистики

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Установите pre-commit хуки:
```bash
pre-commit install
```

## Использование

### CLI

Запуск авто-экстрактора через командную строку:
```bash
python src/agent/auto_extractor.py --url https://example.com
```

Опции:
- `--url`: URL для обработки (обязательный)
- `--db`: путь к базе данных стратегий (по умолчанию: data/strategies.db)

### Python API

Использование авто-экстрактора в коде:
```python
from src.agent.auto_extractor import AutoExtractor

extractor = AutoExtractor()
result = extractor.run_agent('https://example.com')

print(f"Статус: {result['status']}")
print(f"Защита: {'да' if result['has_protection'] else 'нет'}")
print(f"Стратегия: {result['strategy']}")
print(f"Результат в: {result['output_file']}")
```

### REST API

Запуск API сервера:
```bash
uvicorn src.api.app:app --reload
```

#### Эндпоинты

##### POST /extract
Извлекает содержимое веб-страницы.

Запрос:
```json
{
  "url": "https://example.com",
  "options": {
    "timeout": 60,
    "user_agent": "Custom Agent"
  }
}
```

Ответ:
```json
{
  "status": "success",
  "url": "https://example.com",
  "strategy_used": "solve_with_playwright",
  "html_snippet": "<html>...",
  "has_protection": true,
  "protection_type": "cloudflare",
  "output_file": "output/example_com_20240101_123456.json",
  "timestamp": "2024-01-01T12:34:56.789Z",
  "log": []
}
```

##### GET /health
Проверка работоспособности API.

Ответ:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:34:56.789Z"
}
```

##### GET /stats
Получение статистики работы API.

Ответ:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:34:56.789Z",
  "total_requests": 100,
  "success_rate": 0.95,
  "most_common_protection": "cloudflare"
}
```

## База данных стратегий

Стратегии хранятся в SQLite базе данных и содержат:
- Тип защиты
- Название стратегии
- Параметры стратегии
- Количество успешных применений
- Дата последнего использования
- Дата создания

## Стратегии обхода

### Playwright
Использует headless-браузер для загрузки страницы:
- Дожидается полного рендера
- Поддерживает JavaScript
- Может эмулировать реального пользователя

### Модификация заголовков
Изменяет заголовки HTTP-запроса:
- User-Agent
- Accept
- Accept-Language
- Referer
- Другие заголовки

### Прокси
Делает запрос через внешний прокси:
- Поддерживает HTTP/HTTPS
- Аутентификация
- Настраиваемые параметры

### Повторные запросы
Повторяет запрос через случайные интервалы:
- Настраиваемое количество попыток
- Случайные задержки
- Обработка временных блокировок

## Автообучение

### Как работает

1. При неудаче всех известных стратегий запускается процесс исследования:
   - Перебор разных User-Agent'ов
   - Использование Playwright с различными взаимодействиями
   - Комбинации прокси и заголовков
   - Эмуляция геолокации
   - Изменение разрешения экрана

2. Каждая попытка логируется:
   - Используемый метод
   - Результат
   - Ошибки (если есть)
   - HTML или статус ответа

3. Успешные стратегии сохраняются:
   - Название стратегии
   - Параметры
   - Тип защиты
   - Статистика использования

### Экспериментальные подходы

#### User-Agent'ы
- Популярные браузеры
- Мобильные устройства
- Редкие комбинации

#### Playwright взаимодействия
- Прокрутка страницы
- Случайные клики
- Задержки между действиями
- Эмуляция поведения пользователя

#### Прокси и заголовки
- Разные прокси-серверы
- Комбинации заголовков
- Аутентификация

#### Геолокация
- Эмуляция разных стран
- Часовые пояса
- Языковые настройки

#### Разрешение экрана
- Популярные разрешения
- Мобильные устройства
- Нестандартные размеры

### Сохранение стратегий

1. Успешная стратегия сохраняется в базу:
   - Уникальный ID
   - Тип защиты
   - Параметры стратегии
   - Временная метка

2. Статистика использования:
   - Количество успешных применений
   - Дата последнего использования
   - Среднее время выполнения

3. Приоритизация:
   - Часто используемые стратегии
   - Быстрые стратегии
   - Универсальные стратегии

## Агент

### Поведение

1. Получает URL для обработки
2. Проверяет наличие защиты:
   - Делает тестовый запрос
   - Анализирует ответ
   - Определяет тип и признаки защиты
3. Если защита обнаружена:
   - Ищет подходящую стратегию в базе
   - Если не найдена, пробует стандартные стратегии
   - Если стандартные не подходят, запускает исследование
4. Сохраняет результат:
   - HTML страницы
   - Статус операции
   - Примененная стратегия
   - Временная метка

### Результаты

Результаты сохраняются в JSON файлы в директории `output/`:
```json
{
  "url": "https://example.com",
  "timestamp": "20240101_123456",
  "status": "success",
  "strategy": "solve_with_playwright",
  "html": "..."
}
```

### Логирование

Агент логирует все этапы работы:
- URL принят
- Защита обнаружена/не обнаружена
- Применение стратегий
- Успех/неудача
- Сохранение результатов 